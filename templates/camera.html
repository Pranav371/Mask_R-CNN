<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Object Detection</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        .video-container {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .video-box {
            border: 1px solid #ddd;
            padding: 10px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .video-box h3 {
            margin-top: 0;
            text-align: center;
        }
        canvas {
            width: 640px;
            height: 480px;
            background-color: #eee;
            border-radius: 3px;
        }
        .controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            max-width: 640px;
        }
        button {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .classes-container {
            border: 1px solid #ddd;
            padding: 15px;
            background-color: white;
            border-radius: 5px;
            max-width: 640px;
            width: 100%;
        }
        .classes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }
        .class-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        #status {
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            color: white;
            background-color: #333;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Real-time Object Detection</h1>
        <div class="text-center mb-3">
            <a href="{{ url_for('index') }}" class="btn" style="background-color: #4CAF50; color: white; border-radius: 4px; padding: 8px 15px; text-decoration: none; display: inline-block;">
                <i class="fas fa-arrow-left" style="margin-right: 8px;"></i>Back to Upload Page
            </a>
        </div>
        <div id="status">Disconnected</div>
        
        <div class="video-container">
            <div class="video-box">
                <h3>Camera Input</h3>
                <canvas id="camera-feed"></canvas>
            </div>
            <div class="video-box">
                <h3>Processed Output</h3>
                <canvas id="processed-feed"></canvas>
            </div>
        </div>
        
        <div class="controls">
            <button id="startBtn">Start Camera</button>
            <button id="stopBtn" disabled>Stop Camera</button>
            
            <div style="margin-top: 15px;">
                <label for="frameRate">Frame Rate (FPS): <span id="frameRateValue">5</span></label>
                <input type="range" id="frameRate" min="1" max="10" value="5" style="width: 100%;">
                <div style="display: flex; justify-content: space-between; font-size: 0.8em; color: #666;">
                    <span>Lower (Less CPU)</span>
                    <span>Higher (More Responsive)</span>
                </div>
            </div>
            
            <div style="margin-top: 15px;">
                <label for="quality">Image Quality: <span id="qualityValue">60%</span></label>
                <input type="range" id="quality" min="30" max="90" value="60" style="width: 100%;">
                <div style="display: flex; justify-content: space-between; font-size: 0.8em; color: #666;">
                    <span>Lower (Less Memory)</span>
                    <span>Higher (Better Image)</span>
                </div>
            </div>
            
            <div style="margin-top: 10px; font-size: 0.9em; color: #666; text-align: center;">
                <p>If you experience errors, try reducing the frame rate or image quality, or select fewer object classes.</p>
            </div>
        </div>
        
        <div class="classes-container">
            <h3>Object Classes to Detect</h3>
            <div class="classes-grid" id="classes-list">
                {% for idx, class_name in classes %}
                <div class="class-checkbox">
                    <input type="checkbox" id="class-{{ idx }}" value="{{ idx }}" checked>
                    <label for="class-{{ idx }}">{{ class_name }}</label>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <script>
        let socket;
        let videoStream;
        let isStreaming = false;
        let frameInterval = 200; // Default 5 FPS (200ms interval)
        let lastErrorTime = 0;
        const cameraFeed = document.getElementById('camera-feed');
        const processedFeed = document.getElementById('processed-feed');
        const cameraCtx = cameraFeed.getContext('2d');
        const processedCtx = processedFeed.getContext('2d');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const statusDisplay = document.getElementById('status');
        const frameRateSlider = document.getElementById('frameRate');
        const frameRateValue = document.getElementById('frameRateValue');
        const qualitySlider = document.getElementById('quality');
        const qualityValue = document.getElementById('qualityValue');
        
        // Set canvas dimensions
        cameraFeed.width = 640;
        cameraFeed.height = 480;
        processedFeed.width = 640;
        processedFeed.height = 480;
        
        // Initialize frame rate slider
        frameRateSlider.addEventListener('input', function() {
            const fps = parseInt(this.value);
            frameRateValue.textContent = fps;
            frameInterval = Math.round(1000 / fps); // Convert FPS to milliseconds
        });
        
        // Initialize quality slider
        qualitySlider.addEventListener('input', function() {
            const quality = parseInt(this.value);
            qualityValue.textContent = quality + '%';
        });
        
        // Initialize Socket.IO connection
        function initSocket() {
            socket = io();
            
            socket.on('connect', () => {
                statusDisplay.textContent = 'Connected';
                statusDisplay.style.backgroundColor = '#4CAF50';
            });
            
            socket.on('disconnect', () => {
                statusDisplay.textContent = 'Disconnected';
                statusDisplay.style.backgroundColor = '#f44336';
                stopStream();
            });
            
            socket.on('processed_frame', (data) => {
                // Display the processed frame
                const img = new Image();
                img.onload = () => {
                    processedCtx.drawImage(img, 0, 0, processedFeed.width, processedFeed.height);
                };
                img.src = 'data:image/jpeg;base64,' + data.image;
                
                // Display error message if any
                if (data.error) {
                    showError("Error from server: " + data.error);
                }
            });
            
            socket.on('error', (data) => {
                showError(data.message);
            });
        }
        
        // Show error with throttling to prevent too many alerts
        function showError(message) {
            console.error("Socket error:", message);
            
            // Throttle error display to avoid flooding
            const now = Date.now();
            if (now - lastErrorTime > 3000) { // Only show errors every 3 seconds
                lastErrorTime = now;
                
                statusDisplay.textContent = 'Error: ' + message;
                statusDisplay.style.backgroundColor = '#f44336';
                
                // Auto-adjust settings if it's a memory issue
                if (message.includes("memory") || message.includes("allocate")) {
                    // Try reducing quality first
                    if (qualitySlider.value > 40) {
                        qualitySlider.value = Math.max(30, qualitySlider.value - 15);
                        qualityValue.textContent = qualitySlider.value + '%';
                        
                        // Then reduce frame rate if quality is already low
                        if (qualitySlider.value <= 40 && frameRateSlider.value > 2) {
                            frameRateSlider.value = Math.max(1, frameRateSlider.value - 2);
                            frameRateValue.textContent = frameRateSlider.value;
                            frameInterval = Math.round(1000 / frameRateSlider.value);
                        }
                        
                        // Add visual indicator that settings were adjusted
                        statusDisplay.textContent = 'Memory error: Reducing quality and frame rate automatically';
                    }
                }
            }
        }
        
        // Start video stream from webcam
        async function startStream() {
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    }
                });
                
                const video = document.createElement('video');
                video.srcObject = videoStream;
                video.play();
                
                video.onloadedmetadata = () => {
                    isStreaming = true;
                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                    
                    // Reset status if it was showing an error
                    if (statusDisplay.style.backgroundColor === 'rgb(244, 67, 54)') {
                        statusDisplay.textContent = 'Connected';
                        statusDisplay.style.backgroundColor = '#4CAF50';
                    }
                    
                    // Start capturing frames
                    captureFrame(video);
                };
            } catch (err) {
                console.error('Error accessing camera:', err);
                alert('Could not access the camera. Please make sure you have a camera connected and have granted permission.');
            }
        }
        
        // Stop video stream
        function stopStream() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                isStreaming = false;
                startBtn.disabled = false;
                stopBtn.disabled = true;
                
                // Clear canvases
                cameraCtx.clearRect(0, 0, cameraFeed.width, cameraFeed.height);
                processedCtx.clearRect(0, 0, processedFeed.width, processedFeed.height);
            }
        }
        
        // Capture frame from video and send to server
        function captureFrame(video) {
            if (isStreaming) {
                // Draw current video frame to canvas
                cameraCtx.drawImage(video, 0, 0, cameraFeed.width, cameraFeed.height);
                
                // Get selected classes
                const selectedClasses = [];
                document.querySelectorAll('#classes-list input:checked').forEach(checkbox => {
                    selectedClasses.push(checkbox.value);
                });
                
                // Get image quality from slider (as a decimal)
                const imageQuality = parseInt(qualitySlider.value) / 100;
                
                // Convert canvas to base64 image and send to server with current quality setting
                const imageData = cameraFeed.toDataURL('image/jpeg', imageQuality).split(',')[1];
                
                socket.emit('process_frame', {
                    image: imageData,
                    classes: selectedClasses
                });
                
                // Add delay between frames to prevent overwhelming the server and memory issues
                // Using setTimeout instead of requestAnimationFrame for better control of timing
                setTimeout(() => captureFrame(video), frameInterval);
            }
        }
        
        // Event listeners
        startBtn.addEventListener('click', startStream);
        stopBtn.addEventListener('click', stopStream);
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initSocket);
    </script>
</body>
</html> 